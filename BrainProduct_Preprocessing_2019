%%  Initialization
clc; clear;
cd('/Users/soankim/Desktop/Experiment/December/auditory_EEG/ERP_final')
save_everything  = 1;

%% 0. LATENCY SHIFTING
cd('/Users/soankim/Desktop/Experiment/December/auditory_EEG/')

rawDataFiles = dir('*.vhdr');
for  subjID = 1:length(rawDataFiles)
    loadName = rawDataFiles(subjID).name;
    dataName = loadName(1:end-5);
    
    %  Step1:  Import  data.
    EEG = pop_loadbv('.', loadName);
    EEG.setname = dataName;
    
    %  Step  2:  Import  channel  info
    EEG = pop_chanedit(EEG,'lookup', '/Users/soankim/Downloads/eeglab/plugins/dipfit2.3/standard_BESA/standard-10-5-cap385.elp');
    
    %  Step  3:  Resample to 250Hz
    EEG = pop_resample(EEG, 250);
    
    %  Step  4:  Filtering
    EEG = pop_eegfiltnew(EEG, 'locutoff',0.1,'hicutoff',30);
    
     %  Step  5:  Re-referencing.
%     EEG = pop_reref(EEG, [31 32]);
    
    %  Step  6 : Saving.
    EEG = eeg_checkset( EEG, 'eventconsistency');
    % Path to the folder containing the current subject's data
    for index = 1:length(EEG.event)
        if strcmp(EEG.event(index).code,'Stimulus')
            EEG.event(index).latency = EEG.event(index).latency+0.3*250;
        end;
    end;
    EEG = eeg_checkset( EEG, 'eventconsistency');
    
    EEG.setname = [dataName(1:3) '_fil']
    
    if (save_everything)
        EEG = pop_saveset(EEG, 'filename', [EEG.setname '.set'], 'filepath', pwd);
    end;
    
%     events = eeg_eventtable(EEG, 'exportFile', [dataName '.txt']);
end;

rawDataFiles_set = dir('*_fil.set'); 
for  subjID_set = 1:length(rawDataFiles_set)
    loadName_set = rawDataFiles_set(subjID_set).name;
    dataName_set = loadName_set(1:end-4);
    EEG = pop_loadset('filename', loadName_set ,'filepath',pwd);
    
%     pop_eegplot(EEG, 1, 1, 1)
    EEG = pop_saveset(EEG, 'filename', [dataName_set '_events.set'], 'filepath', pwd);
end;
